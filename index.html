<html>
    <head>
        <title>Muddy Branch Greenway Trail</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.5.0/dist/maplibre-gl.css' crossorigin="anonymous"/>
        <script src="https://unpkg.com/maplibre-gl@5.5.0/dist/maplibre-gl.js" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/pmtiles@4.3.0/dist/pmtiles.js"></script>
        <style>
            body { margin: 0; padding: 0; }
            html, body, #map { height: 100%; }
        </style>
    </head>
    <body>
        <style>
            #map canvas {
                cursor: grab;
            }
            .maplibregl-popup div.popup-title {
                font-size: 16px;
                font-weight: bold;
                color: green;
            }
            .maplibregl-popup-content {
                border-radius: 10px !important;
                font-size: 12px;
                padding: 8px;
                width: 120px;
                background: rgba(255, 255, 255, 0.8);
            }
        </style>
        <div id="map"></div>
        <script type="text/javascript">

            // add the PMTiles plugin to the maplibregl global.
            let pm = new pmtiles.Protocol();
            maplibregl.addProtocol("pmtiles",pm.tile);

            let PMTILES_URL = "assets/Muddy_Branch_Greenway_Trail_Map/muddy_branch_reference_data.pmtiles";
            const p = new pmtiles.PMTiles(PMTILES_URL);
            const clickable_layers = ['muddy_branch_parking','muddy_branch_end','muddy_branch_toilet'];
            pm.add(p);

            p.getHeader().then(h => {
                const map = new maplibregl.Map({
                    container: 'map',
                    zoom: 11.7,
                    center: [h.centerLon, h.centerLat],
                    maxBounds: h.bounds,
                    style: "./assets/Muddy_Branch_Greenway_Trail_Map/style.json",
                    attributionControl: false,
                });

                map.setMaxZoom(18);
                map.setMinZoom(10);

                map.addControl(new maplibregl.AttributionControl({compact: true}));
                map.addControl(new maplibregl.NavigationControl(), 'top-right');
                map.addControl(new maplibregl.ScaleControl({
                    maxWidth: 120,
                    unit: 'imperial'
                }),'top-left');

                // When a click event occurs on an access point icon, open a popup at the
                // location of the feature, with description HTML from its properties.
                map.on('click', clickable_layers, (e) => {
                    const coordinates = e.lngLat
                    const properties = e.features[0].properties;

                    let popup_info = properties.name;
                    popup_info = popup_info ? popup_info : properties.operator;

                    // Provide a link to get directions to the location:
                    let directions_url = "https://www.google.com/maps/dir/?api=1&destination=" + coordinates.lat + "," + coordinates.lng;

                    // tailor the popup info based on the amenity type:
                    if (properties.amenity === "parking") {
                        popup_info = popup_info ? popup_info : "Parking";
                        popup_info = "<div class='popup-title'>" + popup_info + "</div>";
                        // Show these properties for parking lots:
                        popup_info += "<br><b>Surface</b>: " + properties.surface;
                        popup_info += properties.fee == 'yes' ? "<br><b>Fee:</b> Fee required</br>" : "<br><b>Fee:</b> No fee required</br>";
                    } else if (properties.amenity === "toilets") {
                        popup_info = popup_info ? popup_info : "Toilets";
                        popup_info = "<div class='popup-title'>" + popup_info + "</div>";
                        // Show these properties for restrooms:
                        popup_info += "<br><b>Portable</b>: " + properties.portable;
                        popup_info += "<br><b>Unisex</b>: " + properties.unisex;
                        popup_info += "<br><b>Changing Table</b>: " + properties.changing_table;
                    } else {
                        popup_info = popup_info ? popup_info : "Landmark";
                        popup_info = "<div class='popup-title'>" + popup_info + "</div>";
                        popup_info += properties.website ? "<a href='" + properties.website + "' target='_blank'><b>Website</b></a>" : "";
                    };
                    popup_info += "<p><a href='" + directions_url + "' target='_blank' rel='noopener noreferrer'>Get Directions</a></p>";

                    new maplibregl.Popup()
                        .setLngLat(coordinates)
                        .setHTML(popup_info)
                        .addTo(map);
                    });

                // Change the cursor to a pointer when the mouse is over the places layer.
                map.on('mouseenter', clickable_layers, () => {
                    map.getCanvas().style.cursor = 'pointer';
                });

                // Change it back to a pointer when it leaves.
                map.on('mouseleave', clickable_layers, () => {
                    map.getCanvas().style.cursor = '';
                });
            });
        </script>
    </body>
</html>